<tool name="planemotest" id="planemotest" version="0.01">
  <!--Cite: Creating re-usable tools from scripts doi:             10.1093/bioinformatics/bts573-->
  <!--Source in git at: https://github.com/fubar2/toolfactory-->
  <!--Created by ross.lazarus@gmail.com at 18/08/2020 20:17:00 using the Galaxy Tool Factory.-->
  <description>Tool to test toolshed tool archives generated by the tool factory.</description>
  <requirements>
    <requirement version="" type="package">planemo</requirement>
    <requirement version="" type="package">python</requirement>
  </requirements>
  <stdio>
    <exit_code range="1:" level="fatal"/>
  </stdio>
  <command interpreter="python"><![CDATA[$runMe --galaxy_root
"$galaxyroot"
--report
$report
--toolout
"$toolout"
--tooltgz
$tooltgz]]></command>
  <configfiles>
    <configfile name="runMe"><![CDATA[

import argparse
import tarfile
import os
import tempfile
import subprocess

parser = argparse.ArgumentParser()
a = parser.add_argument
a('--tooltgz',default='')
a('--report',default=None)
a('--toolout',default=None)
a('--galaxy_root',default=None)
args = parser.parse_args()
toolpath = args.toolout
tf = tarfile.open(args.tooltgz,"r:gz")
tf.extractall(toolpath)
toolname = os.listdir(toolpath)[0]
os.chdir(toolpath)
cl = "planemo test --skip_venv --galaxy_root %s %s" % (args.galaxy_root,toolname)
cll = cl.split(' ')
sto = open(args.report, 'w')
p = subprocess.run(cll, shell=False, stdout=sto)
retval = p.returncode
sto.close()

]]></configfile>
  </configfiles>
  <inputs>
    <param help="Run planemo test on a tool shed tool archive tgz format file generated by the ToolFactory or Planemo" label="tool toolshed tgz archive from history" 
 optional="false" multiple="false" format="tgz" type="data" name="tooltgz" argument="--tooltgz"/>
    <param help="This is where the tgz file will be extracted and tested by planemo" label="output path under galaxy root" value="/tftools/planemo/planemotest" 
  type="text" name="toolout" argument="--toolout"/>
    <param help="This will form the galaxy_root that planemo will use to build a Galaxy" label="Galaxy source root directory to use for running planemo" 
  value="/galaxy-central" type="text" name="galaxyroot" argument="--galaxyroot"/>
  </inputs>
  <outputs>
    <data hidden="false" format="txt" name="report"/>
  </outputs>
  <tests>
    <test>
      <output value="report_sample" name="report"/>
      <param value="tooltgz_sample" name="tooltgz"/>
    </test>
  </tests>
  <help><![CDATA[
**What it Does**

Given a toolshed tgz file generated by a tool factory run, this will unpack it and run planemo test, returning the planemo stdout as a report
It was generated using the tool factory.
 ]]></help>
<citations/>
</tool>

